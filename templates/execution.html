<script>
    // Initialisation de la page d'exécution
    document.addEventListener('DOMContentLoaded', async function() {
        // Vérifier la configuration
        const config = await checkConfiguration()

        if (config)
            // Charger l'état de la synchronisation automatique
            await loadAutoSyncState()
    })
</script>

<section class="fr-accordion">
  <h2 class="fr-accordion__title">
    <button type="button" id="accordion-settings" class="fr-accordion__btn" aria-expanded="true" aria-controls="accordion-3">3. Paramètres</button>
  </h2>
  <div id="accordion-3" class="fr-collapse fr-accordion--light-grey fr-px-4w">

    <div class="fr-mt-4w">
      <fieldset class="fr-fieldset" aria-labelledby="auto-sync-legend">
        <legend class="fr-fieldset__legend" id="auto-sync-legend">
          Synchronisation automatique
          <span class="fr-hint-text">Activez pour synchroniser automatiquement les données chaque jour à minuit</span>
        </legend>

        <div class="fr-fieldset__content">
          <div class="fr-checkbox-group">
            <input type="checkbox" id="auto_sync_enabled" name="auto_sync_enabled" onchange="toggleAutoSync(this.checked)">
            <label class="fr-label" for="auto_sync_enabled">Activer la synchronisation automatique</label>
          </div>
          <div id="last_sync_status" class="fr-mt-2w" style="display: none;"></div>
        </div>
      </fieldset>
    </div>

    <div class="fr-mt-4w">
      <fieldset class="fr-fieldset" aria-labelledby="date-filter-legend">
        <legend class="fr-fieldset__legend" id="date-filter-legend">
          Filtrer par date de dépôt
          <span class="fr-hint-text">Sélectionnez une période pour limiter les dossiers à synchroniser</span>
        </legend>

        <div class="fr-fieldset__content">
          <div class="fr-grid-row fr-grid-row--gutters">
            <div class="fr-col-12 fr-col-md-6">
              <div class="fr-input-group">
                <label class="fr-label" for="date_debut">
                  Date de début
                  <span class="fr-hint-text">Dossiers déposés à partir de cette date (inclus)</span>
                </label>
                <input class="fr-input" type="date" id="date_debut" name="date_debut">
              </div>
            </div>

            <div class="fr-col-12 fr-col-md-6">
              <div class="fr-input-group">
                <label class="fr-label" for="date_fin">
                  Date de fin
                  <span class="fr-hint-text">Dossiers déposés jusqu'à cette date (inclus)</span>
                </label>
                <input class="fr-input" type="date" id="date_fin" name="date_fin">
              </div>
            </div>
          </div>
        </div>
      </fieldset>
    </div>

    <!-- Filtres par statut -->
    <div class="fr-mt-4w">
      <fieldset class="fr-fieldset" aria-labelledby="status-filter-legend">
        <legend class="fr-fieldset__legend" id="status-filter-legend">
          Filtrer par statut
          <span class="fr-hint-text">Aucune sélection = tous les statuts</span>
        </legend>

        <div class="fr-fieldset__content">
          <div class="fr-grid-row fr-grid-row--gutters">
            <div class="fr-col-6 fr-col-md-4 fr-col-lg-2">
              <div class="fr-checkbox-group">
                <input type="checkbox" id="statut_construction" name="statuts" value="en_construction">
                <label class="fr-label" for="statut_construction">En construction</label>
              </div>
            </div>
            <div class="fr-col-6 fr-col-md-4 fr-col-lg-2">
              <div class="fr-checkbox-group">
                <input type="checkbox" id="statut_instruction" name="statuts" value="en_instruction">
                <label class="fr-label" for="statut_instruction">En instruction</label>
              </div>
            </div>
            <div class="fr-col-6 fr-col-md-4 fr-col-lg-2">
              <div class="fr-checkbox-group">
                <input type="checkbox" id="statut_accepte" name="statuts" value="accepte">
                <label class="fr-label" for="statut_accepte">Accepté</label>
              </div>
            </div>
            <div class="fr-col-6 fr-col-md-4 fr-col-lg-2">
              <div class="fr-checkbox-group">
                <input type="checkbox" id="statut_refuse" name="statuts" value="refuse">
                <label class="fr-label" for="statut_refuse">Refusé</label>
              </div>
            </div>
            <div class="fr-col-6 fr-col-md-4 fr-col-lg-2">
              <div class="fr-checkbox-group">
                <input type="checkbox" id="statut_sans_suite" name="statuts" value="sans_suite">
                <label class="fr-label" for="statut_sans_suite">Sans suite</label>
              </div>
            </div>
          </div>
        </div>
      </fieldset>
    </div>

    <!-- Filtres par groupe instructeur -->
    <div class="fr-mt-4w">
      <fieldset class="fr-fieldset" aria-labelledby="group-filter-legend">
        <legend class="fr-fieldset__legend" id="group-filter-legend">
          Filtrer par groupe instructeur
          <span class="fr-hint-text">Aucune sélection = tous les groupes</span>
        </legend>

        <div class="fr-fieldset__content">
          <div id="groupes_container">
            <div class="fr-alert fr-alert--info">
              <p>Chargement des groupes instructeurs...</p>
            </div>
          </div>
        </div>
      </fieldset>
    </div>

    <!-- Boutons d'action pour les filtres -->
    <div class="fr-mt-4w">
      <ul class="fr-btns-group fr-btns-group--inline">
        <li>
          <button class="fr-btn" onclick="applyFilters()">
            Appliquer les filtres
          </button>
        </li>
        <li>
          <button class="fr-btn fr-btn--secondary" onclick="resetFilters()">
            Réinitialiser
          </button>
        </li>
      </ul>
    </div>
  </div>
</section>

<!-- Filtres actifs -->
<div id="active_filters" class="fr-card fr-card--light-grey fr-mb-4w fr-card--no-border" style="display: none;">
    <div class="fr-card__body">
        <div class="fr-card__content">
            <h3 class="fr-card__title">Filtres actifs</h3>
            <div id="active_filters_list" class="fr-mt-2w"></div>
        </div>
    </div>
</div>

<div id="sync_controls" class="fr-my-4w">
    <button class="fr-btn fr-btn--lg" onclick="startSyncAction()" id="start_sync_btn">
        Lancer la synchronisation
    </button>
</div>

<!-- Zone d'exécution -->
<div class="fr-card fr-card--light-grey fr-mb-4w fr-card--no-border">
    <div class="fr-card__body">
        <div class="fr-card__content">
            <h2 class="fr-card__title">Synchronisation</h2>
            
            <!-- Progression -->
            <div id="sync_progress" style="display: none;" class="fr-mt-4w">
                <div class="fr-mb-2w">
                    <div class="fr-grid-row fr-grid-row--middle">
                        <div class="fr-col">
                            <span class="fr-text--bold">Progression</span>
                        </div>
                        <div class="fr-col-auto">
                            <span id="progress_percentage" class="fr-badge fr-badge--blue-ecume">0%</span>
                        </div>
                    </div>
                    <div class="fr-mt-1w">
                        <div style="background-color: #e5e5e5; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div id="progress_bar" class="progress-bar" style="width: 0%; height: 100%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="fr-mb-2w">
                    <div class="fr-alert fr-alert--info">
                        <p id="current_status">Initialisation...</p>
                    </div>
                </div>

                <!-- Statistiques en temps réel -->
                <div id="sync_stats" class="fr-mb-4w">
                    <div class="fr-grid-row fr-grid-row--gutters">
                        <div class="fr-col-6 fr-col-md-3">
                            <div class="fr-card fr-card--grey">
                                <div class="fr-card__body">
                                    <div class="fr-card__content fr-border-bottom fr-border-black fr-border-width--4px">
                                        <p id="processed_count" class="fr-text--bold fr-text--lg fr-text--center fr-mb-2v">0</p>
                                        <div class="fr-grid-row fr-grid-row--middle fr-text--center">
                                            <div class="fr-col">
                                                <p class="fr-mb-0">Dossiers déposés synchronisés</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="fr-col-6 fr-col-md-3">
                            <div class="fr-card fr-card--grey">
                                <div class="fr-card__body">
                                    <div class="fr-card__content fr-border-bottom fr-border-black fr-border-width--4px">
                                        <p id="elapsed_time" class="fr-text--bold fr-text--lg fr-text--center fr-mb-2v">0s</p>
                                        <div class="fr-grid-row fr-grid-row--middle fr-text--center">
                                            <div class="fr-col">
                                                <p class="fr-mb-0">Temps écoulé</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="fr-col-6 fr-col-md-3">
                            <div class="fr-card fr-card--grey">
                                <div class="fr-card__body">
                                    <div class="fr-card__content fr-border-bottom fr-border-black fr-border-width--4px">
                                        <p id="processing_speed" class="fr-text--bold fr-text--lg fr-text--center fr-mb-2v">-</p>
                                        <div class="fr-grid-row fr-grid-row--middle">
                                            <div class="fr-col">
                                                <p class="fr-mb-0">Vitesse traitement</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="fr-col-6 fr-col-md-3">
                            <div class="fr-card fr-card--grey">
                                <div class="fr-card__body">
                                    <div class="fr-card__content fr-border-bottom fr-border-black fr-border-width--4px">
                                        <p id="eta" class="fr-text--bold fr-text--lg fr-text--center fr-mb-2v">-</p>
                                        <div class="fr-grid-row fr-grid-row--middle">
                                            <div class="fr-col">
                                                <p class="fr-mb-0">Temps restant</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Logs en temps réel -->
                <div class="fr-mb-4w">
                    <button class="fr-btn fr-btn--tertiary-no-outline" onclick="logsVisible = toggleLogs(logsVisible)">
                        <span id="logs_toggle_text">Afficher les logs</span>
                        (<span id="logs_count">0</span>)
                    </button>
                    <div id="logs_container" class="log-area fr-mt-2w" style="display: none; height: 300px;">
                        <div id="logs_content"></div>
                    </div>
                </div>
            </div>

            <!-- Résultat final -->
            <div id="sync_result" style="display: none;" class="fr-mt-4w">
                <div id="result_content"></div>
            </div>
        </div>
    </div>
</div>
