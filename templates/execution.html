{% extends "base.html" %}

{% block title %}Ex√©cution - ü¶Ñ One Trick Pony DS to Grist{% endblock %}

{% block content %}
<style>
    /* Force l'ordre d'affichage des titres de cartes */
    .fr-card__title {
        order: -1 !important;
        margin-bottom: 1rem !important;
    }
    
    .fr-card__content {
        display: flex !important;
        flex-direction: column !important;
    }
</style>
<!-- En-t√™te de page -->
<div class="fr-mb-4w">
    <h1 class="fr-h1">
        <i class="fas fa-play fr-mr-2w" style="color: #000091;" aria-hidden="true"></i>
        <span style="color: #000091;">Ex√©cution de la synchronisation</span>
    </h1>
    <p class="fr-text--lead">Configurez les filtres et lancez la synchronisation</p>
</div>

<!-- Statut de la configuration -->
<div class="fr-card fr-mb-4w">
    <div class="fr-card__body">
        <div class="fr-card__content">
            <h2 class="fr-card__title">
                <i class="fas fa-info-circle fr-mr-1w" style="color: #000091;" aria-hidden="true"></i>
                <span style="color: #000091;">Statut de la configuration</span>
            </h2>
            <div id="config_check_result" class="fr-mt-2w">
                <div class="fr-alert fr-alert--info">
                    <p>V√©rification de la configuration en cours...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filtres de donn√©es -->
<div class="fr-card fr-mb-4w">
    <div class="fr-card__body">
        <div class="fr-card__content">
            <h2 class="fr-card__title">
                <i class="fas fa-filter fr-mr-1w" style="color: #000091;" aria-hidden="true"></i>
                <span style="color: #000091;">Filtres de donn√©es</span>
            </h2>
            
            <!-- Filtres par date -->
            <div class="fr-mt-4w">
                <fieldset class="fr-fieldset" aria-labelledby="date-filter-legend">
                    <legend class="fr-fieldset__legend" id="date-filter-legend">
                        Filtrer par date de d√©p√¥t
                        <span class="fr-hint-text">S√©lectionnez une p√©riode pour limiter les dossiers √† synchroniser</span>
                    </legend>
                    
                    <div class="fr-fieldset__content">
                        <div class="fr-grid-row fr-grid-row--gutters">
                            <div class="fr-col-12 fr-col-md-6">
                                <div class="fr-input-group">
                                    <label class="fr-label" for="date_debut">
                                        Date de d√©but
                                        <span class="fr-hint-text">Dossiers d√©pos√©s √† partir de cette date (inclus)</span>
                                    </label>
                                    <input class="fr-input" type="date" id="date_debut" name="date_debut">
                                </div>
                            </div>
                            <div class="fr-col-12 fr-col-md-6">
                                <div class="fr-input-group">
                                    <label class="fr-label" for="date_fin">
                                        Date de fin
                                        <span class="fr-hint-text">Dossiers d√©pos√©s jusqu'√† cette date (inclus)</span>
                                    </label>
                                    <input class="fr-input" type="date" id="date_fin" name="date_fin">
                                </div>
                            </div>
                        </div>
                    </div>
                </fieldset>
            </div>

            <!-- Filtres par statut -->
            <div class="fr-mt-4w">
                <fieldset class="fr-fieldset" aria-labelledby="status-filter-legend">
                    <legend class="fr-fieldset__legend" id="status-filter-legend">
                        Filtrer par statut
                        <span class="fr-hint-text">Aucune s√©lection = tous les statuts</span>
                    </legend>
                    
                    <div class="fr-fieldset__content">
                        <div class="fr-grid-row fr-grid-row--gutters">
                            <div class="fr-col-6 fr-col-md-4 fr-col-lg-2">
                                <div class="fr-checkbox-group">
                                    <input type="checkbox" id="statut_construction" name="statuts" value="en_construction">
                                    <label class="fr-label" for="statut_construction">En construction</label>
                                </div>
                            </div>
                            <div class="fr-col-6 fr-col-md-4 fr-col-lg-2">
                                <div class="fr-checkbox-group">
                                    <input type="checkbox" id="statut_instruction" name="statuts" value="en_instruction">
                                    <label class="fr-label" for="statut_instruction">En instruction</label>
                                </div>
                            </div>
                            <div class="fr-col-6 fr-col-md-4 fr-col-lg-2">
                                <div class="fr-checkbox-group">
                                    <input type="checkbox" id="statut_accepte" name="statuts" value="accepte">
                                    <label class="fr-label" for="statut_accepte">Accept√©</label>
                                </div>
                            </div>
                            <div class="fr-col-6 fr-col-md-4 fr-col-lg-2">
                                <div class="fr-checkbox-group">
                                    <input type="checkbox" id="statut_refuse" name="statuts" value="refuse">
                                    <label class="fr-label" for="statut_refuse">Refus√©</label>
                                </div>
                            </div>
                            <div class="fr-col-6 fr-col-md-4 fr-col-lg-2">
                                <div class="fr-checkbox-group">
                                    <input type="checkbox" id="statut_sans_suite" name="statuts" value="sans_suite">
                                    <label class="fr-label" for="statut_sans_suite">Sans suite</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </fieldset>
            </div>

            <!-- Filtres par groupe instructeur -->
            <div class="fr-mt-4w">
                <fieldset class="fr-fieldset" aria-labelledby="group-filter-legend">
                    <legend class="fr-fieldset__legend" id="group-filter-legend">
                        Filtrer par groupe instructeur
                        <span class="fr-hint-text">Aucune s√©lection = tous les groupes</span>
                    </legend>
                    
                    <div class="fr-fieldset__content">
                        <div id="groupes_container">
                            <div class="fr-alert fr-alert--info">
                                <p>Chargement des groupes instructeurs...</p>
                            </div>
                        </div>
                    </div>
                </fieldset>
            </div>

            <!-- Boutons d'action pour les filtres -->
            <div class="fr-mt-4w">
                <ul class="fr-btns-group">
                    <li>
                        <button class="fr-btn" onclick="applyFilters()">
                            <i class="fas fa-check fr-mr-1w" aria-hidden="true"></i>
                            Appliquer les filtres
                        </button>
                    </li>
                    <li>
                        <button class="fr-btn fr-btn--secondary" onclick="resetFilters()">
                            <i class="fas fa-undo fr-mr-1w" aria-hidden="true"></i>
                            R√©initialiser
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Filtres actifs -->
<div id="active_filters" class="fr-card fr-mb-4w" style="display: none;">
    <div class="fr-card__body">
        <div class="fr-card__content">
            <h3 class="fr-card__title">
                <i class="fas fa-check fr-mr-1w" style="color: #000091;" aria-hidden="true"></i>
                <span style="color: #000091;">Filtres actifs</span>
            </h3>
            <div id="active_filters_list" class="fr-mt-2w"></div>
        </div>
    </div>
</div>

<!-- Zone d'ex√©cution -->
<div class="fr-card">
    <div class="fr-card__body">
        <div class="fr-card__content">
            <h2 class="fr-card__title">
                <i class="fas fa-play fr-mr-1w" style="color: #000091;" aria-hidden="true"></i>
                <span style="color: #000091;">Synchronisation</span>
            </h2>
            
            <div id="sync_controls" class="fr-mt-4w">
                <button class="fr-btn fr-btn--lg" onclick="startSyncAction()" id="start_sync_btn">
                    <i class="fas fa-play fr-mr-1w" aria-hidden="true"></i>
                    Lancer la synchronisation
                </button>
            </div>

            <!-- Progression -->
            <div id="sync_progress" style="display: none;" class="fr-mt-4w">
                <div class="fr-mb-2w">
                    <div class="fr-grid-row fr-grid-row--middle">
                        <div class="fr-col">
                            <span class="fr-text--bold">Progression</span>
                        </div>
                        <div class="fr-col-auto">
                            <span id="progress_percentage" class="fr-badge fr-badge--blue-ecume">0%</span>
                        </div>
                    </div>
                    <div class="fr-mt-1w">
                        <div style="background-color: #e5e5e5; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div id="progress_bar" class="progress-bar" style="width: 0%; height: 100%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="fr-mb-2w">
                    <div class="fr-alert fr-alert--info">
                        <p id="current_status">Initialisation...</p>
                    </div>
                </div>

                <!-- Statistiques en temps r√©el -->
                <div id="sync_stats" class="fr-mb-4w">
                    <div class="fr-grid-row fr-grid-row--gutters">
                        <div class="fr-col-6 fr-col-md-3">
                            <div class="fr-card fr-card--grey">
                                <div class="fr-card__body">
                                    <div class="fr-card__content">
                                        <div class="fr-grid-row fr-grid-row--middle fr-mb-2v">
                                            <div class="fr-col-auto">
                                                <i class="fas fa-clock" style="color: #000091;" aria-hidden="true"></i>
                                            </div>
                                            <div class="fr-col">
                                                <p class="fr-text--xs fr-mb-0" style="color: #000091; font-weight: 600;">Temps √©coul√©</p>
                                            </div>
                                        </div>
                                        <p id="elapsed_time" class="fr-text--bold fr-text--lg fr-mb-0">0s</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="fr-col-6 fr-col-md-3">
                            <div class="fr-card fr-card--grey">
                                <div class="fr-card__body">
                                    <div class="fr-card__content">
                                        <div class="fr-grid-row fr-grid-row--middle fr-mb-2v">
                                            <div class="fr-col-auto">
                                                <i class="fas fa-file-alt" style="color: #000091;" aria-hidden="true"></i>
                                            </div>
                                            <div class="fr-col">
                                                <p class="fr-text--xs fr-mb-0" style="color: #000091; font-weight: 600;">Dossiers trait√©s</p>
                                            </div>
                                        </div>
                                        <p id="processed_count" class="fr-text--bold fr-text--lg fr-mb-0">0</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="fr-col-6 fr-col-md-3">
                            <div class="fr-card fr-card--grey">
                                <div class="fr-card__body">
                                    <div class="fr-card__content">
                                        <div class="fr-grid-row fr-grid-row--middle fr-mb-2v">
                                            <div class="fr-col-auto">
                                                <i class="fas fa-tachometer-alt" style="color: #000091;" aria-hidden="true"></i>
                                            </div>
                                            <div class="fr-col">
                                                <p class="fr-text--xs fr-mb-0" style="color: #000091; font-weight: 600;">Vitesse traitement</p>
                                            </div>
                                        </div>
                                        <p id="processing_speed" class="fr-text--bold fr-text--lg fr-mb-0">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="fr-col-6 fr-col-md-3">
                            <div class="fr-card fr-card--grey">
                                <div class="fr-card__body">
                                    <div class="fr-card__content">
                                        <div class="fr-grid-row fr-grid-row--middle fr-mb-2v">
                                            <div class="fr-col-auto">
                                                <i class="fas fa-hourglass-half" style="color: #000091;" aria-hidden="true"></i>
                                            </div>
                                            <div class="fr-col">
                                                <p class="fr-text--xs fr-mb-0" style="color: #000091; font-weight: 600;">Temps restant</p>
                                            </div>
                                        </div>
                                        <p id="eta" class="fr-text--bold fr-text--lg fr-mb-0">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Logs en temps r√©el -->
                <div class="fr-mb-4w">
                    <button class="fr-btn fr-btn--tertiary-no-outline" onclick="logsVisible = toggleLogs(logsVisible)">
                        <i id="logs_toggle_icon" class="fas fa-chevron-down fr-mr-1w" aria-hidden="true"></i>
                        <span id="logs_toggle_text">Afficher les logs</span>
                        (<span id="logs_count">0</span>)
                    </button>
                    <div id="logs_container" class="log-area fr-mt-2w" style="display: none; height: 300px;">
                        <div id="logs_content"></div>
                    </div>
                </div>
            </div>

            <!-- R√©sultat final -->
            <div id="sync_result" style="display: none;" class="fr-mt-4w">
                <div id="result_content"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let logsVisible = false
let currentConfig = null
let currentTaskId = null

const startSyncAction = async () => currentTaskId = await startSync(currentConfig)

document.addEventListener(
  'DOMContentLoaded',
  async () => {
    currentConfig = await checkConfiguration()
    loadGroupes()
  }
)

// Socket.IO pour les mises √† jour en temps r√©el
socket.on('task_update', function(data) {
  if (data.task_id === currentTaskId) {
    updateTaskProgress(data.task)
    if (data.task.status === 'completed' || data.task.status === 'error') {
      currentTaskId = null;
    }
  }
})
</script>
{% endblock %}
