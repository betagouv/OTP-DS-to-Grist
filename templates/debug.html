{% extends "base.html" %}

{% block title %}D√©bogage - ü¶Ñ One Trick Pony DS to Grist{% endblock %}

{% block content %}
<style>
    /* Force l'ordre d'affichage des titres de cartes */
    .fr-card__title {
        order: -1 !important;
        margin-bottom: 1rem !important;
    }
    
    .fr-card__content {
        display: flex !important;
        flex-direction: column !important;
    }
</style>

<!-- En-t√™te de page -->
<div class="fr-mb-4w">
    <h1 class="fr-h1">
        <i class="fas fa-bug fr-mr-2w" style="color: #000091;" aria-hidden="true"></i>
        <span style="color: #000091;">Outils de d√©bogage</span>
    </h1>
    <p class="fr-text--lead">Informations syst√®me et diagnostics</p>
</div>

<!-- Test de connectivit√© -->
<div class="fr-card">
    <div class="fr-card__body">
        <div class="fr-card__content">
            <h2 class="fr-card__title">
                <i class="fas fa-network-wired fr-mr-1w" style="color: #000091;" aria-hidden="true"></i>
                <span style="color: #000091;">Test de connectivit√©</span>
            </h2>
            
            <div class="fr-mt-4w">
                <div class="fr-grid-row fr-grid-row--gutters">
                    <div class="fr-col-12 fr-col-md-6">
                        <h3 class="fr-h6">WebSocket</h3>
                        <button class="fr-btn" onclick="testWebSocket()">
                            <i class="fas fa-plug fr-mr-1w" aria-hidden="true"></i>
                            Tester WebSocket
                        </button>
                        <div id="websocket_status" class="fr-mt-3w">
                            <div class="fr-alert fr-alert--info">
                                <p>Test de connexion WebSocket...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="fr-col-12 fr-col-md-6">
                        <h3 class="fr-h6">APIs externes</h3>
                        <button class="fr-btn" onclick="testExternalConnections()">
                            <i class="fas fa-satellite-dish fr-mr-1w" aria-hidden="true"></i>
                            Tester les connexions externes
                        </button>
                        <div id="external_tests_result" class="fr-mt-3w"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Variables d'environnement -->
<div class="fr-card fr-mb-4w">
    <div class="fr-card__body">
        <div class="fr-card__content">
            <h2 class="fr-card__title">
                <i class="fas fa-cogs fr-mr-1w" style="color: #000091;" aria-hidden="true"></i>
                <span style="color: #000091;">Variables d'environnement</span>
            </h2>
            
            <div class="fr-mt-4w">
                <div class="fr-grid-row fr-grid-row--gutters">
                    <!-- Variables de filtrage -->
                    <div class="fr-col-12">
                        <h3 class="fr-h6">Variables de filtrage</h3>
                        <div>
                            <table class="fr-table fr-table--no-caption">
                                <thead>
                                    <tr>
                                        <th scope="col">Variable</th>
                                        <th scope="col">Valeur</th>
                                        <th scope="col">Statut</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for var, value in filter_vars.items() %}
                                    <tr>
                                        <td><code class="fr-text--xs">{{ var }}</code></td>
                                        <td><code class="fr-text--xs">{{ value }}</code></td>
                                        <td>
                                            {% if value == "Non d√©fini" %}
                                            <span class="fr-badge fr-badge--warning fr-badge--sm">
                                                <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                                            </span>
                                            {% else %}
                                            <span class="fr-badge fr-badge--info fr-badge--sm">
                                                <i class="fas fa-info" aria-hidden="true"></i>
                                            </span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rapport des synchronisations -->
<div class="fr-card fr-mb-4w">
    <div class="fr-card__body">
        <div class="fr-card__content">
            <h2 class="fr-card__title">
                <i class="fas fa-chart-line fr-mr-1w" style="color: #000091;" aria-hidden="true"></i>
                <span style="color: #000091;">Rapport des synchronisations (24h)</span>
            </h2>
            <div id="sync-report" class="fr-mt-3w">
                <div class="fr-alert fr-alert--info">
                    <p>Chargement du rapport...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Contr√¥les du Scheduler -->
<div class="fr-card fr-mb-4w">
    <div class="fr-card__body">
        <div class="fr-card__content">
            <h2 class="fr-card__title">
                <i class="fas fa-clock fr-mr-1w" style="color: #000091;" aria-hidden="true"></i>
                <span style="color: #000091;">Contr√¥les du Scheduler</span>
            </h2>
            <button id="reload-scheduler-btn" class="fr-btn fr-btn--secondary">
                <i class="fas fa-sync fr-mr-1w" aria-hidden="true"></i>
                Recharger le Scheduler
            </button>
            <div id="reload-result" class="fr-mt-3w" style="display: none;"></div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let wsTestTimeout
    
    document.addEventListener('DOMContentLoaded', function() {
        // Tester automatiquement WebSocket au chargement
        setTimeout(testWebSocket, 1000)

        // Charger le rapport des syncs
        loadSyncReport()
    })

    async function loadSyncReport() {
        const reportDiv = document.getElementById('sync-report');
        try {
            const response = await fetch('/api/sync-report');
            const data = await response.json();
            if (data.logs && data.logs.length > 0) {
                let html = '<table class="fr-table fr-table--no-caption"><thead><tr><th scope="col">Timestamp</th><th scope="col">Statut</th><th scope="col">Message</th><th scope="col">Config/Schedule</th><th scope="col">D√©marche</th><th scope="col">User/Doc</th></tr></thead><tbody>';
                data.logs.forEach(log => {
                    const date = new Date(log.timestamp);
                    const readableTimestamp = date.toLocaleString('fr-FR', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    const statusClass = log.status === 'success' ? 'fr-badge fr-badge--success fr-badge--sm' : 'fr-badge fr-badge--error fr-badge--sm';
                    html += `<tr><td>${readableTimestamp}</td><td><span class="${statusClass}">${log.status}</span></td><td>${log.message}</td><td>${log.config_id}/${log.schedule_id}</td><td>${log.demarche}</td><td>${log.grist_user_id}/${log.grist_doc_id}</td></tr>`;
                });
                html += '</tbody></table>';
                reportDiv.innerHTML = html;
            } else {
                reportDiv.innerHTML = '<div class="fr-alert fr-alert--info"><p>Aucune synchronisation dans les derni√®res 24h.</p></div>';
            }
        } catch (error) {
            reportDiv.innerHTML = `<div class="fr-alert fr-alert--error"><p>Erreur de chargement du rapport: ${error.message}</p></div>`;
        }
    }

    // √âcouteur pour recharger le scheduler
    document.getElementById('reload-scheduler-btn').addEventListener('click', async () => {
        const resultDiv = document.getElementById('reload-result');
        try {
            const response = await fetch('/api/reload-scheduler', { method: 'POST' });
            const data = await response.json();
            resultDiv.style.display = 'block';
            resultDiv.className = (data.success ? 'fr-alert fr-alert--success' : 'fr-alert fr-alert--error') + ' fr-mt-3w';
            let html = `<p>${data.message}</p>`;
            if (data.jobs && data.jobs.length > 0) {
                html += '<h4>Jobs programm√©s :</h4><ul>';
                data.jobs.forEach(job => {
                    html += `<li>Schedule ${job.schedule_id} (config ${job.config_id}, d√©marche ${job.demarche}) : prochaine ex√©cution ${job.next_run || 'N/A'}, document ${job.document}</li>`;
                });
                html += '</ul>';
            }
            resultDiv.innerHTML = html;
        } catch (error) {
            resultDiv.style.display = 'block';
            resultDiv.className = 'fr-alert fr-alert--error fr-mt-3w';
            resultDiv.innerHTML = `<p>Erreur r√©seau: ${error.message}</p>`;
        }
    })
</script>
{% endblock %}
