{% extends "base.html" %}

{% block title %}Accueil - ðŸ¦„ One Trick Pony DN to Grist{% endblock %}

{% block content %}
{% include 'configuration.html' %}
{% include 'execution.html' %}
{% endblock %}

{% block scripts %}
<script>
window.config = null
let logsVisible = false
let currentTaskId = null

window.updateDeleteButton = function(config) {
  const deleteBtn = document.getElementById('delete_config_btn')
  if (!config || !config.otp_config_id) {
    deleteBtn.disabled = true
    deleteBtn.title = 'Aucune configuration Ã  supprimer'
  } else {
    deleteBtn.disabled = false
    deleteBtn.title = ''
  }
}

document.addEventListener('DOMContentLoaded', async () => {

  // Initialisation de la page d'exÃ©cution
  // VÃ©rifier la configuration
  const config = await checkConfiguration()

  // Mettre Ã  jour le bouton de suppression
  window.updateDeleteButton(config)

  if (config)
    // Charger l'Ã©tat de la synchronisation automatique
    await loadAutoSyncState()

  // Charger la configuration au dÃ©marrage
  window.config = await loadConfiguration()
  loadGroupes()

  // Mettre le focus sur le premier champs de configuration si vide
  if (!window.config || !window.config.ds_api_token) {

    setTimeout(
      () => {
        document.getElementById('ds_api_token').focus()
      }
      , 500 // Attendre que l'accordÃ©on soit ouvert
    )

  }
})


const startSyncAction = async () => currentTaskId = await startSync(window.config)

// Socket.IO pour les mises Ã  jour en temps rÃ©el
socket.on('task_update', function(data) {
  if (data.task_id === currentTaskId) {
    updateTaskProgress(data.task)
    if (data.task.status === 'completed' || data.task.status === 'error') {
      currentTaskId = null;
    }
  }
})
</script>
{% endblock %}
