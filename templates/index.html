{% extends "base.html" %}

{% block title %}Accueil - ü¶Ñ One Trick Pony DS to Grist{% endblock %}

{% block content %}
{% include 'configuration.html' %}
{% include 'execution.html' %}
{% endblock %}

{% block scripts %}
<script>
window.config = null
let logsVisible = false
let currentTaskId = null

window.updateDeleteButton = function(config) {
  const deleteBtn = document.getElementById('delete_config_btn')
  if (!config || !config.otp_config_id) {
    deleteBtn.disabled = true
    deleteBtn.title = 'Aucune configuration √† supprimer'
  } else {
    deleteBtn.disabled = false
    deleteBtn.title = ''
  }
}

document.addEventListener('DOMContentLoaded', async () => {

  // Initialisation de la page d'ex√©cution
  // V√©rifier la configuration
  const config = await checkConfiguration()

  // Mettre √† jour le bouton de suppression
  window.updateDeleteButton(config)

  if (config)
    // Charger l'√©tat de la synchronisation automatique
    await loadAutoSyncState()

  // Charger la configuration au d√©marrage
  window.config = await loadConfiguration()
  loadGroupes()

  // Mettre le focus sur le premier champs de configuration si vide
  if (!window.config || !window.config.ds_api_token) {

    setTimeout(
      () => {
        document.getElementById('ds_api_token').focus()
      }
      , 500 // Attendre que l'accord√©on soit ouvert
    )

  }
})


const startSyncAction = async () => currentTaskId = await startSync(window.config)

const pocitAction = async () => {
  try {
    const tokenInfo = await grist.docApi.getAccessToken({readOnly: false})
    const {token} = tokenInfo
    console.log({token})

    // Extraire docId et userId du token JWT
    const payload = JSON.parse(atob(tokenInfo.token.split('.')[1]))
    const {docId, userId} = payload
    console.log({docId, userId})

    // Cr√©er un compte de service avec ce token et le restreindre au document
    const response = await fetch('/api/create-service-account', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        token: token,
        doc_id: docId,
        label: 'POC Service Account',
        description: 'Created via POC button - Restricted to document ' + docId,
        expires_at: '2042-10-10'
      })
    })

    const result = await response.json()
    if (result.success) {
      console.log('Service account created and restricted:', result.service_account)
      alert('Compte de service cr√©√© avec succ√®s et restreint au document !\nCl√© API: ' + result.service_account.key + '\nDocument: ' + result.doc_id)
    } else {
      console.error('Erreur:', result.message)
      alert('Erreur lors de la cr√©ation: ' + result.message)
    }
  } catch (error) {
    console.error('Erreur:', error)
    alert('Erreur: ' + error.message)
  }
}

// Socket.IO pour les mises √† jour en temps r√©el
socket.on('task_update', function(data) {
  if (data.task_id === currentTaskId) {
    updateTaskProgress(data.task)
    if (data.task.status === 'completed' || data.task.status === 'error') {
      currentTaskId = null;
    }
  }
})
</script>
{% endblock %}
