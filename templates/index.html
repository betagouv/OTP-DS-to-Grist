{% extends "base.html" %}

{% block title %}Accueil - ðŸ¦„ One Trick Pony DN to Grist{% endblock %}

{% block content %}
<form id="config-form">
  {% include 'configuration.html' %}
  {% include 'execution.html' %}
</form>
{% endblock %}

{% block scripts %}
<script>
// ===== INITIALISATIONS GLOBALES =====
window.config = null
let logsVisible = false
let currentTaskId = null
window.saveTimeout = null

// ===== SOCKET.IO =====
const socket = io()

socket.on('connect_error', function(error) {
    console.error('Erreur de connexion Socket.IO:', error)
    showNotification('Erreur de connexion en temps rÃ©el', 'error')
})

socket.on('connect', function() {
    console.log('ConnectÃ© au serveur via Socket.IO')
})

// Gestion des mises Ã  jour en temps rÃ©el
socket.on('task_update', function(data) {
  if (data.task_id === currentTaskId) {
    updateTaskProgress(data.task)
    if (data.task.status === 'completed' || data.task.status === 'error') {
      currentTaskId = null
    }
  }
})

// ===== INITIALISATION DE LA PAGE =====
document.addEventListener('DOMContentLoaded', async () => {
  // ===== GESTION DE LA NAVIGATION DE L'AIDE =====
  const currentPath = window.location.pathname
  const navLinks = document.querySelectorAll('.fr-nav__link')

  navLinks.forEach(link => {
    if (link.getAttribute('href') === currentPath ||
      (currentPath === '/' && link.getAttribute('href') === '/')) {
      link.setAttribute('aria-current', 'page')
    }
  })

  // VÃ©rifier la configuration
  const checkedConfig = await checkConfiguration(true)

  // Mettre Ã  jour le bouton de suppression
  updateDeleteButton()

  if (checkedConfig) {
    // Charger l'Ã©tat de la synchronisation automatique
    await loadAutoSyncState()
  }

  // Charger la configuration et groupes
  window.otp_config_id = checkedConfig?.otp_config_id
  updateDeleteButton()
  await loadGroupes(window.otp_config_id)
  await loadConfiguration()

  // Focus sur le premier champ si vide
  if (!window.otp_config_id) {
    setTimeout(() => {
      document.getElementById('ds_api_token').focus()
    }, 500)
  }
})

// ===== ACTIONS DE SYNCHRONISATION =====
const startSyncAction = async () => currentTaskId = await startSync(window.otp_config_id)

// ===== AFFICHAGE DU TITRE DE BIENVENUE =====
if (document.cookie.search('welcome') === -1) {
  document.querySelector('#welcome-title').style.display = 'block'
  document.cookie = 'welcome=true; SameSite=None; Secure'
}

// ===== ACTIONS DE SAUVEGARDE =====
const saveConfigAction = async () => {
  setButtonsDisabled(true)
  clearTimeout(saveTimeout)
  saveTimeout = setTimeout(
     async () => {
       try {
         const dsToken = document.getElementById('ds_api_token').value
         const dsNumber = document.getElementById('demarche_number').value
         const gristKey = document.getElementById('grist_api_key').value

         const config = await getConfiguration()

         if ((!dsToken || !config.has_ds_token) && !dsNumber) {
           console.log('Pas de sauvegarde sans token DN ni numÃ©ro de dÃ©marche')
           return setButtonsDisabled(false)
         }

         // VÃ©rification spÃ©cifique pour ds_api_token : obligatoire si pas en base
         if (!dsToken && !config.has_ds_token) {
           showNotification('Le champ "Token API DÃ©marches SimplifiÃ©es" est requis', 'error')
           return setButtonsDisabled(false)
         }

         if (!await testDemarchesConnection(true))
           return setButtonsDisabled(false)

         // Test connexion Grist seulement si clÃ© prÃ©sente
         if (
           (gristKey || config.has_grist_key)
             && !await testGristConnection(true)
         )
           return setButtonsDisabled(false)

         await saveConfiguration()
         const checkedConfig = await checkConfiguration()
         window.otp_config_id = checkedConfig.otp_config_id

         await loadGroupes(window.otp_config_id)
         await loadConfiguration()

       } finally {
         setButtonsDisabled(false)
       }
     }
    , 1500
  )
}

// ===== ACTIONS DE SAUVEGARDE AUTO =====
const form = document.querySelector('form')
form.addEventListener('input', () => {
  updateButtonsState()
  saveConfigAction()
})
</script>
{% endblock %}
