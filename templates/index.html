{% extends "base.html" %}

{% block title %}Accueil - ü¶Ñ One Trick Pony DN to Grist{% endblock %}

{% block content %}
<form id="config-form">
  {% include 'configuration.html' %}
  {% include 'execution.html' %}
</form>
{% endblock %}

{% block scripts %}
<script>
// ===== INITIALISATIONS GLOBALES =====
window.config = null
let logsVisible = false
let currentTaskId = null

// ===== SOCKET.IO =====
const socket = io()

socket.on('connect_error', function(error) {
    console.error('Erreur de connexion Socket.IO:', error)
    showNotification('Erreur de connexion en temps r√©el', 'error')
})

socket.on('connect', function() {
    console.log('Connect√© au serveur via Socket.IO')
})

// Gestion des mises √† jour en temps r√©el
socket.on('task_update', function(data) {
  if (data.task_id === currentTaskId) {
    updateTaskProgress(data.task)
    if (data.task.status === 'completed' || data.task.status === 'error') {
      currentTaskId = null
    }
  }
})

// ===== INITIALISATION DE LA PAGE =====
document.addEventListener('DOMContentLoaded', async () => {
  // ===== GESTION DE LA NAVIGATION DE L'AIDE =====
  const currentPath = window.location.pathname
  const navLinks = document.querySelectorAll('.fr-nav__link')

  navLinks.forEach(link => {
    if (link.getAttribute('href') === currentPath ||
      (currentPath === '/' && link.getAttribute('href') === '/')) {
      link.setAttribute('aria-current', 'page')
    }
  })

  // V√©rifier la configuration
  const checkedConfig = await checkConfiguration(true)

  // Mettre √† jour le bouton de suppression
  updateDeleteButton()

  if (checkedConfig) {
    // Charger l'√©tat de la synchronisation automatique
    await loadAutoSyncState()
  }

  // Charger la configuration et groupes
  const loadedConfig = await loadConfiguration()
  window.otp_config_id = loadedConfig.otp_config_id
  updateDeleteButton()
  loadGroupes(window.otp_config_id)

  // Focus sur le premier champ si vide
  if (!window.otp_config_id) {
    setTimeout(() => {
      document.getElementById('ds_api_token').focus()
    }, 500)
  }
})

// ===== ACTIONS DE SYNCHRONISATION =====
const startSyncAction = async () => currentTaskId = await startSync(window.otp_config_id)

// ===== AFFICHAGE DU TITRE DE BIENVENUE =====
if (document.cookie.search('welcome') === -1) {
  document.querySelector('#welcome-title').style.display = 'block'
  document.cookie = 'welcome=true; SameSite=None; Secure'
}

// ===== ACTIONS DE SAUVEGARDE =====
const saveConfigAction = async () => {
  // Tests conditionnels selon les champs renseign√©s
  const dsToken = document.getElementById('ds_api_token').value
  const dsNumber = document.getElementById('demarche_number').value
  const gristKey = document.getElementById('grist_api_key').value

  const config = await getConfiguration()

  if ((!dsToken || !config.has_ds_token) && !dsNumber) {
    console.log('Pas de sauvegarde sans token DN ni num√©ro de d√©marche')
    return
  }

  if (!await testDemarchesConnection(true))
    return false

  // Test connexion Grist seulement si cl√© pr√©sente
  if (
    (gristKey || config.has_grist_key)
    && !await testGristConnection(true)
  )
    return false

  await saveConfiguration()
  await checkConfiguration()
  const loadedConfig = await loadConfiguration()
  window.otp_config_id = loadedConfig.otp_config_id

  await loadGroupes(window.otp_config_id)
}

// ===== ACTIONS DE SAUVEGARDE AUTO =====
const form = document.querySelector('form')
form.addEventListener('input', saveConfigAction)
</script>
{% endblock %}
