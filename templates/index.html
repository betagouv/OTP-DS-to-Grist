{% extends "base.html" %}

{% block title %}Accueil - ðŸ¦„ One Trick Pony DN to Grist{% endblock %}

{% block content %}
{% include 'configuration.html' %}
{% include 'execution.html' %}
{% endblock %}

{% block scripts %}
<script>
// ===== INITIALISATIONS GLOBALES =====
// FIXME
window.config = null
let logsVisible = false
let currentTaskId = null

// ===== SOCKET.IO =====
const socket = io()

socket.on('connect_error', function(error) {
    console.error('Erreur de connexion Socket.IO:', error)
    showNotification('Erreur de connexion en temps rÃ©el', 'error')
})

socket.on('connect', function() {
    console.log('ConnectÃ© au serveur via Socket.IO')
})

// Gestion des mises Ã  jour en temps rÃ©el
socket.on('task_update', function(data) {
  if (data.task_id === currentTaskId) {
    updateTaskProgress(data.task)
    if (data.task.status === 'completed' || data.task.status === 'error') {
      currentTaskId = null
    }
  }
})

document.addEventListener('DOMContentLoaded', () => {
})

// ===== INITIALISATION DE LA PAGE =====
document.addEventListener('DOMContentLoaded', async () => {
  // ===== GESTION DE LA NAVIGATION DE L'AIDE =====
  const currentPath = window.location.pathname
  const navLinks = document.querySelectorAll('.fr-nav__link')

  navLinks.forEach(link => {
    if (link.getAttribute('href') === currentPath ||
      (currentPath === '/' && link.getAttribute('href') === '/')) {
      link.setAttribute('aria-current', 'page')
    }
  })

  // VÃ©rifier la configuration
  const checkedConfig = await checkConfiguration(true)

  // Mettre Ã  jour le bouton de suppression
  updateDeleteButton()

  if (checkedConfig) {
    // Charger l'Ã©tat de la synchronisation automatique
    await loadAutoSyncState()
  }

  // Charger la configuration et groupes
  const loadedConfig = await loadConfiguration()
  window.otp_config_id = loadedConfig.otp_config_id
  updateDeleteButton()
  loadGroupes()

  // Initialiser les listeners automatiques pour les filtres
  document.getElementById('date_debut').addEventListener('change', applyFilters)
  document.getElementById('date_fin').addEventListener('change', applyFilters)
  document.querySelectorAll('input[name="statuts"]').forEach(el => {
    el.addEventListener('change', applyFilters)
  })

  // Focus sur le premier champ si vide
  if (!window.otp_config_id) {
    setTimeout(() => {
      document.getElementById('ds_api_token').focus()
    }, 500)
  }
})

// ===== ACTIONS DE SYNCHRONISATION =====
const startSyncAction = async () => currentTaskId = await startSync(window.otp_config_id)

// ===== AFFICHAGE DU TITRE DE BIENVENUE =====
if (document.cookie.search('welcome') === -1) {
  document.querySelector('#welcome-title').style.display = 'block'
  document.cookie = 'welcome=true; SameSite=None; Secure'
}
</script>
{% endblock %}
